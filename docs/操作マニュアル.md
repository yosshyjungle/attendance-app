# Smart Attendance QR 操作マニュアル

**日商簿記三鷹福祉専門学校 出席管理Webシステム**

Ver 1.0 | 2026年2月

---

## 目次

1. [システム概要](#1-システム概要)
2. [初回セットアップ](#2-初回セットアップ)
3. [管理者の操作](#3-管理者の操作)
4. [教員の操作](#4-教員の操作)
5. [学生の操作](#5-学生の操作)
6. [出席判定ルール](#6-出席判定ルール)
7. [前期・後期・時間割について](#7-前期後期時間割について)

---

## 1. システム概要

### 利用者区分と権限

| 区分 | 主な機能 |
|------|----------|
| **学生** | QRによる入退室、出席状況の確認 |
| **教員** | 出席一覧確認、スプレッドシート形式での出席入力、ステータス修正 |
| **管理者** | 組織・クラス・学生・授業の管理、QRコード表示 |

### クラス構成

- 1年経営ビジネス学科
- 1年情報ビジネス学科
- 2年経営ビジネス学科
- 2年情報ビジネス学科

### 授業スケジュール

- **曜日**: 月～金曜日
- **時限**: 1～4限
- **規定時数**: 1日4時間

---

## 2. 初回セットアップ

### 2.1 環境変数の設定

`.env` ファイルに以下を設定してください。

```
# Supabase（PostgreSQL）
DATABASE_URL="postgresql://..."

# Clerk認証
NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY="pk_..."
CLERK_SECRET_KEY="sk_..."

# Clerk Webhook（ユーザー役割同期用）
CLERK_WEBHOOK_SIGNING_SECRET="whsec_..."

# 本番URL（QRコード生成用）
NEXT_PUBLIC_APP_URL="https://your-app.vercel.app"
```

### 2.2 Clerk Webhookの設定

1. [Clerk Dashboard](https://dashboard.clerk.com) → Webhooks → Add Endpoint
2. URL: `https://your-app.vercel.app/api/webhooks/clerk`
3. イベント: `user.created`, `user.updated`, `user.deleted`
4. 署名シークレットを `.env` の `CLERK_WEBHOOK_SIGNING_SECRET` に設定

### 2.3 ユーザー役割の設定（教員・管理者）

Clerk Dashboard でユーザーの **Public metadata** に `role` を設定します。

- 教員: `{ "role": "TEACHER" }`
- 管理者: `{ "role": "ADMIN" }`
- 未設定: 学生として扱われます

### 2.4 シードデータの投入

```bash
npm run db:seed
```

組織・クラス・科目・時間割が自動作成されます。

---

## 3. 管理者の操作

### 3.1 ダッシュボード

**URL**: `/dashboard/admin`

組織・クラス・学生・授業の一覧を確認できます。

### 3.2 組織の作成

1. クラス一覧で「組織を作成」をクリック
2. または `/dashboard/admin/organizations/new` にアクセス
3. 組織名を入力して「作成」

※ シード実行済みの場合は「日商簿記三鷹福祉専門学校」が作成済みです。

### 3.3 クラスの作成・編集・削除

#### 新規作成

1. 「新規作成」→「クラス新規作成」
2. 組織とクラス名を選択・入力
3. 「作成」をクリック

#### 編集

1. クラス一覧の「編集」をクリック
2. クラス名・組織を変更
3. 「保存」をクリック

#### 削除

1. クラス一覧の「削除」をクリック
2. 確認ダイアログで「削除」を実行

※ 学生・授業が紐づいている場合は一緒に削除されます。

### 3.4 学生の登録

1. 「学生登録」→「学生新規登録」
2. クラス、氏名、学籍番号を入力
3. **Clerk User ID**（任意）: 学生がログインしてQR入退室する場合は、Clerk Dashboard で確認したユーザーIDを入力
4. 「登録」をクリック

### 3.5 授業の作成

1. 「授業新規作成」
2. クラス、授業名、日付、時限（1～4）、種別（通常授業/期末試験/イベント）を入力
3. 開始・終了時刻を設定
4. 「作成」をクリック

※ 授業の日付とクラスを選ぶと、時間割に基づいてその日の授業が自動作成されます（教員の出席入力画面で）。

### 3.6 QRコードの表示

1. 授業一覧の「QR表示」をクリック
2. 入室用・退室用のQRコードが表示されます
3. 教室のスクリーンに表示して学生にスキャンさせます

---

## 4. 教員の操作

### 4.1 ダッシュボード

**URL**: `/dashboard/teacher`

本日の授業一覧と、各授業の出席状況を確認できます。

### 4.2 出席入力（スプレッドシート形式）

**URL**: `/dashboard/teacher/attendance`

Google スプレッドシートと同様の形式で出席を入力できます。

#### 操作手順

1. 「出席入力（スプレッドシート形式）」をクリック
2. **日付**と**クラス**を選択
3. 表が表示されます（学生が未登録の場合は「学生が登録されていません」と表示）
4. 各時限のセルに以下を入力：

| 入力 | 意味 |
|------|------|
| **1** | 出席 |
| **2** | 遅刻 |
| **3** | 公欠 |
| **4** | 早退 |
| **空** | 欠席 |

5. **特記**列に必要に応じてメモを入力
6. 「保存」をクリック

#### 補足

- 日付とクラスを選ぶと、その日の授業（1～4限）が自動作成されます
- 時間割（カリキュラム）に基づいて科目名が自動設定されます

### 4.3 出席ステータスの修正

1. 教員ダッシュボードで該当授業を表示
2. 該当学生の「修正」をクリック
3. ステータス（出席/遅刻/欠席/早退/公欠）を選択
4. 修正理由を入力（任意）
5. 「保存」をクリック

---

## 5. 学生の操作

### 5.1 初回登録（オンボーディング）

初めてログインした学生は、以下の情報を登録する画面が表示されます。

1. **学生番号**（必須）
2. **氏名**（必須）
3. **メールアドレス**（必須）
4. **クラス**（必須・選択）

登録完了後、ダッシュボードに遷移します。

※ 教員・管理者はこの登録をスキップし、直接ダッシュボードにアクセスします。

### 5.2 ダッシュボード

**URL**: `/dashboard/student`

当日の出席状況と最近の出席記録を確認できます。

※ 学生として登録されていない場合は「学生として登録されていません。管理者に連絡してください。」と表示されます。

### 5.3 QR入退室

#### 入室

1. 教室のスクリーンに表示された**入室用QRコード**をスマートフォンでスキャン
2. または `/scan/[トークン]?action=in` のURLを開く
3. 「入室する」をクリック

#### 退室

1. **退室用QRコード**をスキャン
2. または `/scan/[トークン]?action=out` のURLを開く
3. 「退室する」をクリック

#### 注意事項

- ログイン（Clerk認証）が必要です
- 管理者が学生登録時に Clerk User ID を紐づけている必要があります
- 自分のクラスの授業のQRのみ有効です

---

## 6. 出席判定ルール

### 自動判定（QR入退室時）

| 条件 | 判定 |
|------|------|
| 授業開始時刻までにQR入室 | **出席** |
| 開始後15分以内にQR入室 | **遅刻** |
| 開始15分経過後も未入室 | **欠席** |
| 終了15分前より前に退室 | **早退** |

### 手動修正

- 遅延証明書提出後、教員が**公欠**に修正可能
- その他の例外も教員が修正可能

---

## 7. 前期・後期・時間割について

### 学期

| 学期 | 期間 |
|------|------|
| **前期** | 4月1日～9月30日 |
| **後期** | 10月1日～3月31日 |

### 授業種別

- **通常授業**: 通常のカリキュラムに基づく授業
- **期末試験**: 前期・後期の期末試験
- **イベント**: 旅行、バーベキュー等の学校行事

### 時間割

カリキュラムに基づき、各クラス・曜日・時限ごとに科目が設定されています。出席入力画面で日付とクラスを選ぶと、時間割に基づいてその日の授業が自動作成されます。

---

## トラブルシューティング

### 学生が「学生として登録されていません」と表示される

→ 管理者が学生登録を行い、Clerk User ID を紐づけてください。

### QRスキャンで「Invalid lesson token」と表示される

→ 正しい授業のQRコードをスキャンしているか確認してください。QRコードは授業ごとに異なります。

### 出席入力画面で「この日の授業が未登録です」と表示される

→ 日付とクラスを選択した状態で画面を開くと、授業が自動作成されます。再度読み込みしてみてください。

### 教員・管理者としてログインできない

→ Clerk Dashboard でユーザーの Public metadata に `role` を設定してください。

---

## お問い合わせ

システムに関するお問い合わせは、管理者までご連絡ください。
